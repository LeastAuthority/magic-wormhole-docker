= magic-wormhole Docker images

Create Docker images of magic-wormhole backend services:

* link:https://github.com/magic-wormhole/magic-wormhole-mailbox-server[Magic Wormhole Mailbox Server] -> https://hub.docker.com/r/leastauthority/magic-wormhole-mailbox
* link:https://github.com/magic-wormhole/magic-wormhole-mailbox-server[Magic Wormhole Transit Relay] -> https://hub.docker.com/r/leastauthority/magic-wormhole-relay


== Basic instructions

In order to have an exact reference to the version to use


|===
|Variant |Command

|latest tag reachable from current commit
a|[source]
----
git describe --tags
----

|Short git hash of the current commit
a|[source]
----
git rev-parse --short HEAD
----
|===

Update the GitHub Action `.github/workflows/docker-image.yml` with the desired version reference:

[source]
----
...
    strategy:
      matrix:
        target:
          - directory: mailbox
            image: leastauthority/magic-wormhole-mailbox
            version: <version reference>
          - directory: relay
            image: leastauthority/magic-wormhole-relay
            version: <version reference>
    steps:
...
----

== Example

To manually build for a tag like reference, e. g. `0.4.1-11-gac91c3a`.

=== Build Mailbox Service

[source]
----
cd mailbox
----

==== Build Docker image

[source]
----
docker build . -t leastauthority/magic-wormhole-mailbox:0.4.1-11-gac91c3a --build-arg VERSION_TAG=0.4.1-11-gac91c3a
----

==== Push image

With version tag

[source]
----
docker push leastauthority/magic-wormhole-mailbox:0.4.1-11-gac91c3a
----

and latest version

[source]
----
docker tag leastauthority/magic-wormhole-mailbox:0.4.1-11-gac91c3a leastauthority/magic-wormhole-mailbox:latest
docker push leastauthority/magic-wormhole-mailbox:latest
----

=== Build Relay Service

relay service instructions are similar ...